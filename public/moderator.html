<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Na lovu – Moderátor</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <main class="container">
    <h1>Moderátor</h1>

    <section class="card" id="room-setup">
      <h2>Vytvořit / připojit místnost</h2>
      <div class="row">
        <label>Název moderátora
          <input id="modName" placeholder="Moderátor" />
        </label>
        <label>Kód místnosti
          <input id="roomCode" placeholder="např. ABCD1" maxlength="10" />
        </label>
      </div>
      <div class="row">
        <button id="btnCreate">Vytvořit novou</button>
        <button id="btnJoin">Připojit k existující</button>
      </div>
      <p id="hint"></p>
    </section>

    <section class="card" id="room-panel" style="display:none">
      <h2>Místnost <code class="badge" id="roomLabel"></code></h2>
      <div class="row">
        <div class="card" style="flex:1">
          <h3>Stav</h3>
          <div id="status"></div>
        </div>
        <div class="card" style="flex:1">
          <h3>Skóre</h3>
          <div id="scores"></div>
        </div>
      </div>
    </section>

    <section class="card" id="question-panel" style="display:none">
      <h2>Otázka</h2>
      <label>Text otázky
        <textarea id="qText" rows="3" placeholder="Zadejte otázku..."></textarea>
      </label>
      <div class="row">
        <label>Časový limit (s)
          <input id="qTime" type="number" min="3" max="120" value="20" />
        </label>
        <label>
          <input id="qMC" type="checkbox" />
          Výběr z možností (A, B, C...)
        </label>
      </div>
      <div id="mcWrap" style="display:none">
        <p>Zadejte možnosti (max 8). Správnou označte číslem.</p>
        <div id="options"></div>
        <div class="row">
          <label>Index správné odpovědi (0=A, 1=B...)
            <input id="qCorrect" type="number" min="0" max="7" />
          </label>
          <button id="btnAddOption" type="button">+ Přidat možnost</button>
        </div>
      </div>
      <div class="row">
        <button id="btnStart">Spustit otázku</button>
        <button id="btnEnd">Vyhodnotit / ukončit</button>
      </div>

      <div id="answers" class="card" style="margin-top:12px; display:none">
        <h3>Odpovědi</h3>
        <div class="row">
          <div>
            <strong>Soutěžící:</strong> <span id="aContestant">—</span>
            <label style="display:block;margin-top:6px"><input type="checkbox" id="markContestant"/> Správně</label>
          </div>
          <div>
            <strong>Lovec:</strong> <span id="aChaser">—</span>
            <label style="display:block;margin-top:6px"><input type="checkbox" id="markChaser"/> Správně</label>
          </div>
        </div>
        <div class="row">
          <button id="btnApplyMarks">Potvrdit skóre</button>
        </div>
      </div>
    </section>

    <p><a href="/">← Zpět na připojení</a></p>
  </main>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const $ = (id) => document.getElementById(id);
    const ioClient = io();

    let roomCode = '';

    function renderRoom(room) {
      if (!room) return;
      $('room-panel').style.display = 'block';
      $('question-panel').style.display = 'block';
      $('roomLabel').textContent = room.code;
      $('status').innerHTML = `
        <div>Soutěžící: <strong>${room.contestant || '—'}</strong></div>
        <div>Lovec: <strong>${room.chaser || '—'}</strong></div>
      `;
      $('scores').innerHTML = `
        <div>Soutěžící: <strong>${room.scores.contestant}</strong></div>
        <div>Lovec: <strong>${room.scores.chaser}</strong></div>
      `;

      if (room.question) {
        $('answers').style.display = 'block';
      } else {
        $('answers').style.display = 'none';
        $('aContestant').textContent = '—';
        $('aChaser').textContent = '—';
        $('markContestant').checked = false;
        $('markChaser').checked = false;
      }
    }

    ioClient.on('roomCreated', (payload) => {
      roomCode = payload.code;
      $('room-setup').style.display = 'none';
      $('hint').textContent = '';
    });

    ioClient.on('roomUpdate', (room) => {
      renderRoom(room);
    });

    ioClient.on('questionResult', (result) => {
      // Could show toast
      console.log('Vyhodnocení', result);
    });

    ioClient.on('errorMessage', (m) => alert(m));

    $('btnCreate').onclick = () => {
      const name = $('modName').value.trim() || 'Moderátor';
      const code = $('roomCode').value.trim();
      ioClient.emit('createRoom', { roomCode: code, name });
      $('hint').textContent = 'Zakládám místnost...';
    };

    $('btnJoin').onclick = () => {
      const name = $('modName').value.trim() || 'Moderátor';
      const code = $('roomCode').value.trim().toUpperCase();
      if (!code) return alert('Zadejte kód místnosti');
      roomCode = code;
      ioClient.emit('moderatorJoin', { roomCode: code, name });
      $('room-setup').style.display = 'none';
    };

    $('qMC').onchange = () => {
      $('mcWrap').style.display = $('qMC').checked ? 'block' : 'none';
    };

    $('btnAddOption').onclick = () => addOptionInput('');

    function addOptionInput(value='') {
      const idx = $('options').children.length;
      const div = document.createElement('div');
      div.className = 'row';
      div.innerHTML = `<label>Možnost ${String.fromCharCode(65+idx)}<input data-idx="${idx}" value="${value}"></label>`;
      $('options').appendChild(div);
    }

    $('btnStart').onclick = () => {
      if (!roomCode) return alert('Nejprve vytvořte/připojte místnost');
      const text = $('qText').value.trim();
      const timeLimit = parseInt($('qTime').value, 10) || 20;
      const isMC = $('qMC').checked;
      const question = { text, timeLimit };
      if (isMC) {
        const opts = Array.from($('options').querySelectorAll('input')).map(i => i.value).filter(v => v.trim() !== '');
        if (opts.length < 2) return alert('Zadejte aspoň 2 možnosti');
        question.options = opts;
        const correct = $('qCorrect').value;
        if (correct !== '') question.correctOption = Number(correct);
      }
      ioClient.emit('startQuestion', { roomCode, question });
    };

    $('btnEnd').onclick = () => {
      if (!roomCode) return;
      ioClient.emit('endQuestion', { roomCode });
    };

    $('btnApplyMarks').onclick = () => {
      if (!roomCode) return;
      const marks = { contestant: $('markContestant').checked, chaser: $('markChaser').checked };
      ioClient.emit('endQuestion', { roomCode, marks });
    };

    // Show answers live
    ioClient.on('roomUpdate', (room) => {
      if (!room) return;
      if (room.answers && room.answers.includes('contestant')) {
        $('aContestant').textContent = 'Odpověď zamknuta';
      }
      if (room.answers && room.answers.includes('chaser')) {
        $('aChaser').textContent = 'Odpověď zamknuta';
      }
    });
  </script>
</body>
</html>
